<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>peewee与异步操作 | yuchanns&#39;Atelier</title>
    <meta name="description" content="focus on python|php">
    <link rel="icon" href="/yuchanns.png">
  <meta name="google-site-verification" content="h0GK-apopUhINJJe5Jp3XopZswk6EK_JQT_fVMrs6A0">
  <meta name="baidu-site-verification" content="OeVj0fzw4S">
    
    <link rel="preload" href="/assets/css/0.styles.eb8afa4a.css" as="style"><link rel="preload" href="/assets/js/app.f1298f72.js" as="script"><link rel="preload" href="/assets/js/3.cd7d6ac4.js" as="script"><link rel="preload" href="/assets/js/21.0fe3f19e.js" as="script"><link rel="prefetch" href="/assets/js/1.1516f943.js"><link rel="prefetch" href="/assets/js/10.0d42dcc2.js"><link rel="prefetch" href="/assets/js/11.0f58cf83.js"><link rel="prefetch" href="/assets/js/12.7aabf4e0.js"><link rel="prefetch" href="/assets/js/13.10474817.js"><link rel="prefetch" href="/assets/js/14.d0809dde.js"><link rel="prefetch" href="/assets/js/15.d43c7e25.js"><link rel="prefetch" href="/assets/js/16.9edcbcca.js"><link rel="prefetch" href="/assets/js/17.2e08000f.js"><link rel="prefetch" href="/assets/js/18.a95bab7b.js"><link rel="prefetch" href="/assets/js/19.88e29e11.js"><link rel="prefetch" href="/assets/js/20.1376d87e.js"><link rel="prefetch" href="/assets/js/22.3c5a2a49.js"><link rel="prefetch" href="/assets/js/23.3eb72fcb.js"><link rel="prefetch" href="/assets/js/24.a91e9467.js"><link rel="prefetch" href="/assets/js/25.c0a6bc69.js"><link rel="prefetch" href="/assets/js/26.b6899417.js"><link rel="prefetch" href="/assets/js/27.b51f60a4.js"><link rel="prefetch" href="/assets/js/28.792179b8.js"><link rel="prefetch" href="/assets/js/29.2d6289f9.js"><link rel="prefetch" href="/assets/js/4.b7305242.js"><link rel="prefetch" href="/assets/js/5.05b6ad67.js"><link rel="prefetch" href="/assets/js/6.b1a2f38f.js"><link rel="prefetch" href="/assets/js/7.ebfb88b5.js"><link rel="prefetch" href="/assets/js/8.f9ac094a.js"><link rel="prefetch" href="/assets/js/9.52d65113.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eb8afa4a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" data-v-2db1e33a><div data-v-9292c008 data-v-2db1e33a><nav class="navbar" data-v-9292c008><div class="container" data-v-9292c008><a href="/" class="router-link-active" data-v-9292c008><span class="navbar-site-name" data-v-9292c008>
          yuchanns'Atelier
        </span></a> <div class="navbar-toggler" data-v-9292c008><svg class="icon" style="font-size:1.2em;" data-v-9292c008 data-v-9292c008><title data-v-9292c008 data-v-9292c008>menu</title><use xlink:href="#icon-menu" data-v-9292c008 data-v-9292c008></use></svg></div> <div class="navbar-links" data-v-9292c008><a href="/" class="navbar-link" data-v-9292c008>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-9292c008>
            Posts
          </a><a href="/snippets/" class="navbar-link" data-v-9292c008>
            Snippets
          </a><a href="/awesome/" class="navbar-link" data-v-9292c008>
            Awesome
          </a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-9292c008></div></div> <div class="banner" data-v-66d98992 data-v-2db1e33a data-v-2db1e33a><div class="container" data-v-66d98992><div class="center" data-v-66d98992><h1 data-v-66d98992 data-v-2db1e33a>
          peewee与异步操作
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-226a4f67 data-v-226a4f67><main class="main" data-v-226a4f67><div class="post" data-v-226a4f67 data-v-226a4f67><section class="post-meta main-div" data-v-0afc19fc><section class="post-date clearfix" data-v-0afc19fc><span class="create-date" data-v-0afc19fc>
      发布时间 : 2018-12-18
    </span> <span class="update-date" data-v-0afc19fc>
      最后修改 : Invalid Date
    </span></section> <section class="post-links" data-v-0afc19fc><a href="/posts/2018/12/12/usage-of-peewee.html" class="post-link" data-v-0afc19fc>
      上一篇 : peewee用法考察
    </a> <a href="/posts/2019/01/05/_2019-todolist.html" class="post-link" data-v-0afc19fc>
      下一篇 : 2019-TODOList
    </a></section></section> <article class="main-div"><div class="content default"><p><div class="table-of-contents"> <ul><li><a href="/posts/2018/12/18/peewee-with-async.html#我们需要什么类库">我们需要什么类库</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#与tornado结合：同步阻塞下的情况">与tornado结合：同步阻塞下的情况</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#与tornado结合：异步硬盘io非阻塞下的情况">与tornado结合：异步硬盘IO非阻塞下的情况</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#其余常规操作">其余常规操作</a> <ul><li><a href="/posts/2018/12/18/peewee-with-async.html#插入-更新数据">插入/更新数据</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#jion查询">jion查询</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#union查询">union查询</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#聚合查询">聚合查询</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#删除操作">删除操作</a> <!----></li></ul></li></ul> </div></p> <p>在<a href="https://www.yuchanns.xyz/posts/2018/12/12/usage-of-peewee.html" target="_blank" rel="noopener noreferrer">《peewee用法考察》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中，我初步掌握peewee的一些常用操作。而做这些准备，是为了在tornado中使用。
tornado是一个异步网络IO非阻塞框架，这意味着涉及到IO阻塞操作，我们都应该以异步的形式去进行。而peewee本身并不是异步的，因此我们还需要引入另外一些库才能更好的契合tornado。</p> <h2 id="我们需要什么类库"><a href="#我们需要什么类库" aria-hidden="true" class="header-anchor">#</a> 我们需要什么类库</h2> <ul><li>peewee-async</li> <li>aiomysql</li></ul> <p><a href="https://github.com/05bit/peewee-async" target="_blank" rel="noopener noreferrer">peewee-async<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是一个基于asyncio的封装成的库，用于进行peewee异步操作。而peewee是基于pymysql进行操作的，pymysql异步操作mysql则需要aiomysql库的支持。
注意：目前支持tornado3.0+的peewee-async属于预发行版本，需要添加-pre参数下载。</p> <blockquote><p>Version 0.6.0a is published as pre-release, mind the &quot;a&quot; in version identifier. That means in order to install it you should specify --pre flag for pip.</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>pip <span class="token function">install</span> -pre peewee-async
pip <span class="token function">install</span> aiomysql
</code></pre></div><h2 id="与tornado结合：同步阻塞下的情况"><a href="#与tornado结合：同步阻塞下的情况" aria-hidden="true" class="header-anchor">#</a> 与tornado结合：同步阻塞下的情况</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> tornado<span class="token punctuation">.</span>web <span class="token keyword">import</span> Application<span class="token punctuation">,</span> RequestHandler
<span class="token keyword">from</span> tornado<span class="token punctuation">.</span>httpserver <span class="token keyword">import</span> HTTPServer
<span class="token keyword">from</span> tornado<span class="token punctuation">.</span>ioloop <span class="token keyword">import</span> IOLoop
<span class="token keyword">from</span> models <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sys


<span class="token keyword">class</span> <span class="token class-name">MainHandler</span><span class="token punctuation">(</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        uid <span class="token operator">=</span> self<span class="token punctuation">.</span>get_argument<span class="token punctuation">(</span><span class="token string">'uid'</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span>
        query <span class="token operator">=</span> User<span class="token punctuation">.</span>select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uname<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uid <span class="token operator">==</span> uid<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'uname:%s'</span> <span class="token operator">%</span> query<span class="token punctuation">.</span>uname<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">TestHandler</span><span class="token punctuation">(</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'test here'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> Application<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">(</span>r<span class="token string">'/'</span><span class="token punctuation">,</span> MainHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>r<span class="token string">'/test'</span><span class="token punctuation">,</span> TestHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        server <span class="token operator">=</span> HTTPServer<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
        server<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>
        IOLoop<span class="token punctuation">.</span>current<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Exit'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><p>启动mysql交互界面，锁住user表的读写操作，模拟硬盘IO阻塞。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">use</span> peewee<span class="token punctuation">;</span>
<span class="token keyword">lock</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">write</span><span class="token punctuation">;</span>
</code></pre></div><p>然后先后访问localhost:8000/和localhost:8000/test，我们会发现两个访问都阻塞在请求状态，直到我们进行</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">unlock</span> <span class="token keyword">table</span><span class="token punctuation">;</span>
</code></pre></div><p>解锁写锁之后才能获得数据。</p> <h2 id="与tornado结合：异步硬盘io非阻塞下的情况"><a href="#与tornado结合：异步硬盘io非阻塞下的情况" aria-hidden="true" class="header-anchor">#</a> 与tornado结合：异步硬盘IO非阻塞下的情况</h2> <p>为了使用peewee-async，首先我们需要对models.py文件一点修改：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> peewee <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;引入peewee_async相关类库&quot;&quot;&quot;</span>
<span class="token keyword">from</span> peewee_async <span class="token keyword">import</span> MySQLDatabase <span class="token keyword">as</span> AsyncMySQLDatabase<span class="token punctuation">,</span> Manager

<span class="token comment"># database = MySQLDatabase('peewee', **{'charset': 'utf8', 'use_unicode': True, 'host': 'localhost', 'port': 3306, 'user': 'root', 'password': ''})</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;将数据库连接改成peewee_async.MySQLDatabase&quot;&quot;&quot;</span>
database <span class="token operator">=</span> AsyncMySQLDatabase<span class="token punctuation">(</span><span class="token string">'peewee'</span><span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">{</span><span class="token string">'charset'</span><span class="token punctuation">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token string">'use_unicode'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">'host'</span><span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token string">'port'</span><span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">UnknownField</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>_<span class="token punctuation">,</span> <span class="token operator">**</span>__<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>


<span class="token keyword">class</span> <span class="token class-name">BaseModel</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;将事务改成atomic_async&quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>trans <span class="token operator">=</span> database<span class="token punctuation">.</span>atomic_async
        <span class="token triple-quoted-string string">&quot;&quot;&quot;添加一个Manager类&quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span><span class="token builtin">object</span> <span class="token operator">=</span> Manager<span class="token punctuation">(</span>database<span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        database <span class="token operator">=</span> database

<span class="token comment"># 下略……</span>

</code></pre></div><p><a href="https://peewee-async.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">peewee-async官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>写得很简略，使用方法也不难，只是在peewee原有的基础上多加了一点嵌套操作。
比如，查询操作：（其中async/await是python3.5+异步操作的新特性，若不明白请自行查阅官方文档）</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MainHandler</span><span class="token punctuation">(</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;使用async关键字标识异步操作&quot;&quot;&quot;</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        user <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token punctuation">)</span>
        uname <span class="token operator">=</span> self<span class="token punctuation">.</span>get_argument<span class="token punctuation">(</span><span class="token string">'uname'</span><span class="token punctuation">,</span> <span class="token string">'j'</span><span class="token punctuation">)</span>
        uid <span class="token operator">=</span> self<span class="token punctuation">.</span>get_argument<span class="token punctuation">(</span><span class="token string">'uid'</span><span class="token punctuation">,</span> <span class="token number">10002</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">&quot;&quot;&quot;使用await关键字等待阻塞操作&quot;&quot;&quot;</span>
            <span class="token triple-quoted-string string">&quot;&quot;&quot;单条查询使用object.get()方法将原本的peewee操作包裹起来&quot;&quot;&quot;</span>
            row <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>
                User<span class="token punctuation">.</span>select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uname<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uid <span class="token operator">==</span> uid<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token triple-quoted-string string">&quot;&quot;&quot;多条查询&quot;&quot;&quot;</span>
            query <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
                User<span class="token punctuation">.</span>select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uname<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uname<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>uname<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token keyword">except</span> User<span class="token punctuation">.</span>DoesNotExist<span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">&quot;&quot;&quot;当查不到数据的时候会抛出DoesNotExist错误&quot;&quot;&quot;</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'查无数据'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'row uname: %s and query unames:%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>row<span class="token punctuation">.</span>uname<span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>row<span class="token punctuation">.</span>uname <span class="token keyword">for</span> row <span class="token keyword">in</span> query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><p>启动进程，当我们再次锁住user表写锁，然后先后访问localhost:8000/和localhost:8000/test，就会发现，虽然第一个请求还在阻塞状态，第二个请求却已经成功看到屏幕上打印出来的&quot;test here&quot;文字。而当我们解锁user表之后，第一个请求也能顺利完成。</p> <h2 id="其余常规操作"><a href="#其余常规操作" aria-hidden="true" class="header-anchor">#</a> 其余常规操作</h2> <h3 id="插入-更新数据"><a href="#插入-更新数据" aria-hidden="true" class="header-anchor">#</a> 插入/更新数据</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;md5加密密码&quot;&quot;&quot;</span>
    m <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
    m<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">'123456'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pwd <span class="token operator">=</span> m<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;头像&quot;&quot;&quot;</span>
    avartar <span class="token operator">=</span> <span class="token string">'https://avatars2.githubusercontent.com/u/25029451'</span>
    user <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data_source <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span>avartar<span class="token punctuation">,</span> <span class="token string">'Doreis'</span><span class="token punctuation">,</span> pwd<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>avartar<span class="token punctuation">,</span> <span class="token string">'Dorein'</span><span class="token punctuation">,</span> pwd<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>avartar<span class="token punctuation">,</span> <span class="token string">'Doreiv'</span><span class="token punctuation">,</span> pwd<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    field <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">.</span>avartar<span class="token punctuation">,</span> User<span class="token punctuation">.</span>uname<span class="token punctuation">,</span> User<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;插入多条数据&quot;&quot;&quot;</span>
        <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
            User<span class="token punctuation">.</span>insert_many<span class="token punctuation">(</span>data_source<span class="token punctuation">,</span> field<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>User<span class="token punctuation">.</span>select<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> User<span class="token punctuation">.</span>integral<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uname <span class="token operator">==</span> <span class="token string">'Doreis'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;使用async关键字开启事务&quot;&quot;&quot;</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> user<span class="token punctuation">.</span>trans<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">&quot;&quot;&quot;更新数据&quot;&quot;&quot;</span>
            <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span>User<span class="token punctuation">.</span>update<span class="token punctuation">(</span>
                integral<span class="token operator">=</span>result<span class="token punctuation">.</span>integral<span class="token operator">+</span><span class="token number">100</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uid <span class="token operator">==</span> result<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token triple-quoted-string string">&quot;&quot;&quot;插入单条数据&quot;&quot;&quot;</span>
            <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span>Integral<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>
                uid<span class="token operator">=</span>result<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
                change<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
                total<span class="token operator">=</span>result<span class="token punctuation">.</span>integral <span class="token operator">+</span> <span class="token number">100</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'insert complete'</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'insert failed'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="jion查询"><a href="#jion查询" aria-hidden="true" class="header-anchor">#</a> jion查询</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
   user <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">try</span><span class="token punctuation">:</span>
       <span class="token triple-quoted-string string">&quot;&quot;&quot;join查询&quot;&quot;&quot;</span>
       query_join <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
           Balance<span class="token punctuation">.</span>select<span class="token punctuation">(</span>
               User<span class="token punctuation">.</span>uname<span class="token punctuation">,</span> Balance<span class="token punctuation">.</span>change<span class="token punctuation">,</span>
               Balance<span class="token punctuation">.</span>total<span class="token punctuation">,</span> Balance<span class="token punctuation">.</span>addtime
           <span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
               User<span class="token punctuation">,</span> JOIN<span class="token punctuation">.</span>RIGHT_OUTER<span class="token punctuation">,</span>
               on<span class="token operator">=</span><span class="token punctuation">(</span>Balance<span class="token punctuation">.</span>uid <span class="token operator">==</span> User<span class="token punctuation">.</span>uid<span class="token punctuation">)</span>
           <span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>
               Balance<span class="token punctuation">.</span>uid <span class="token operator">==</span> <span class="token number">10012</span>
           <span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token operator">-</span>Balance<span class="token punctuation">.</span>addtime<span class="token punctuation">)</span>
       <span class="token punctuation">)</span>
       <span class="token keyword">for</span> row_join <span class="token keyword">in</span> query_join<span class="token punctuation">:</span>
           <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s:%.2f:%.2f:%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
               row_join<span class="token punctuation">.</span>user<span class="token punctuation">.</span>uname<span class="token punctuation">,</span> row_join<span class="token punctuation">.</span>change<span class="token punctuation">,</span>
               row_join<span class="token punctuation">.</span>total<span class="token punctuation">,</span> row_join<span class="token punctuation">.</span>addtime
           <span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">except</span> User<span class="token punctuation">.</span>DoesNotExist<span class="token punctuation">:</span>
       <span class="token triple-quoted-string string">&quot;&quot;&quot;当查不到数据的时候会抛出DoesNotExist错误&quot;&quot;&quot;</span>
       self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'查无数据'</span><span class="token punctuation">)</span>
   <span class="token keyword">else</span><span class="token punctuation">:</span>
       self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'query unames:%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>row<span class="token punctuation">.</span>uname<span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>row<span class="token punctuation">.</span>uname <span class="token keyword">for</span> row <span class="token keyword">in</span> query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="union查询"><a href="#union查询" aria-hidden="true" class="header-anchor">#</a> union查询</h3> <p>关于union操作，peewee_async原本并不支持。我开了个<a href="https://github.com/05bit/peewee-async/issues/116" target="_blank" rel="noopener noreferrer">issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>询问了作者，作者表示做出一些修改就可以支持。</p> <blockquote><p>Not sure if <code>select()</code> coroutine could handle that but you can try it <code>peewee_async.select(union_query))</code>
If it works, then we can just add handling <code>ModelCompoundSelectQuery</code> to <code>execute()</code> via <code>select()</code></p></blockquote> <p>所以，首先，我们对peewee_async库的源文件<code>peewee_async.py</code>中的
<code>execute()</code>做出一点修改：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Execute *SELECT*, *INSERT*, *UPDATE* or *DELETE* query asyncronously.

    :param query: peewee query instance created with ``Model.select()``,
                  ``Model.update()`` etc.
    :return: result depends on query type, it's the same as for sync
        ``query.execute()``
    &quot;&quot;&quot;</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;在这里，添加ModelCompoundSelectQuery类&quot;&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token punctuation">(</span>peewee<span class="token punctuation">.</span>Select<span class="token punctuation">,</span> peewee<span class="token punctuation">.</span>ModelCompoundSelectQuery<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        coroutine <span class="token operator">=</span> select
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> peewee<span class="token punctuation">.</span>Update<span class="token punctuation">)</span><span class="token punctuation">:</span>
        coroutine <span class="token operator">=</span> update
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> peewee<span class="token punctuation">.</span>Insert<span class="token punctuation">)</span><span class="token punctuation">:</span>
        coroutine <span class="token operator">=</span> insert
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> peewee<span class="token punctuation">.</span>Delete<span class="token punctuation">)</span><span class="token punctuation">:</span>
        coroutine <span class="token operator">=</span> delete
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        coroutine <span class="token operator">=</span> raw_query

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> coroutine<span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这样在使用<code>execute()</code>方法时，peewee_async就能识别union。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token triple-quoted-string string">&quot;&quot;&quot;union查询&quot;&quot;&quot;</span>
b_query <span class="token operator">=</span> <span class="token punctuation">(</span>Balance<span class="token punctuation">.</span>select<span class="token punctuation">(</span>
    Balance<span class="token punctuation">.</span>b<span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Balance<span class="token punctuation">.</span>change<span class="token punctuation">,</span>
    Balance<span class="token punctuation">.</span>total<span class="token punctuation">,</span> Balance<span class="token punctuation">.</span>addtime
<span class="token punctuation">)</span><span class="token punctuation">)</span>
i_query <span class="token operator">=</span> <span class="token punctuation">(</span>Integral<span class="token punctuation">.</span>select<span class="token punctuation">(</span>
    Integral<span class="token punctuation">.</span>i<span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Integral<span class="token punctuation">.</span>change<span class="token punctuation">,</span>
    Integral<span class="token punctuation">.</span>total<span class="token punctuation">,</span> Integral<span class="token punctuation">.</span>addtime
<span class="token punctuation">)</span><span class="token punctuation">)</span>
query_union <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
    <span class="token punctuation">(</span>b_query <span class="token operator">+</span> i_query<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>SQL<span class="token punctuation">(</span><span class="token string">'addtime desc'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>offset<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="聚合查询"><a href="#聚合查询" aria-hidden="true" class="header-anchor">#</a> 聚合查询</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token triple-quoted-string string">&quot;&quot;&quot;聚合函数&quot;&quot;&quot;</span>
fn_max <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>User<span class="token punctuation">.</span>select<span class="token punctuation">(</span>fn<span class="token punctuation">.</span>MAX<span class="token punctuation">(</span>User<span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="删除操作"><a href="#删除操作" aria-hidden="true" class="header-anchor">#</a> 删除操作</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span>User<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>uid <span class="token operator">==</span> <span class="token number">10012</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>简单的操作先记录到这里，其余操作未完待续~</p></div></article> <section class="post-meta main-div" data-v-0afc19fc><section class="post-date clearfix" data-v-0afc19fc><span class="create-date" data-v-0afc19fc>
      发布时间 : 2018-12-18
    </span> <span class="update-date" data-v-0afc19fc>
      最后修改 : Invalid Date
    </span></section> <section class="post-links" data-v-0afc19fc><a href="/posts/2018/12/12/usage-of-peewee.html" class="post-link" data-v-0afc19fc>
      上一篇 : peewee用法考察
    </a> <a href="/posts/2019/01/05/_2019-todolist.html" class="post-link" data-v-0afc19fc>
      下一篇 : 2019-TODOList
    </a></section></section> <div id="post-comments" class="main-div"><!----></div></div></main> <aside class="aside" data-v-226a4f67><div class="info-card main-div" data-v-acfd4c20 data-v-226a4f67><div class="info-card-header" data-v-acfd4c20><img src="https://avatars3.githubusercontent.com/u/25029451" alt="yuchanns" class="info-avatar" data-v-acfd4c20></div> <div class="info-card-body" data-v-acfd4c20><section class="info-nickname" data-v-acfd4c20>
      yuchanns
    </section> <section class="info-desc" data-v-acfd4c20>A non professional programmer which attempt to be professional</section> <section class="info-contact" data-v-acfd4c20><section data-v-acfd4c20><span title="Shenzhen, China" data-v-acfd4c20 data-v-acfd4c20><svg class="icon" style="font-size:1em;" data-v-acfd4c20 data-v-acfd4c20><title data-v-acfd4c20 data-v-acfd4c20>Shenzhen, China</title><use xlink:href="#icon-location" data-v-acfd4c20 data-v-acfd4c20></use></svg><span class="info-text" data-v-acfd4c20 data-v-acfd4c20>
          Shenzhen, China
        </span></span></section> <!----> <section data-v-acfd4c20><a href="mailto:airamusume@gmail.com" title="airamusume@gmail.com" data-v-acfd4c20 data-v-acfd4c20><svg class="icon" style="font-size:1em;" data-v-acfd4c20 data-v-acfd4c20><title data-v-acfd4c20 data-v-acfd4c20>airamusume@gmail.com</title><use xlink:href="#icon-email" data-v-acfd4c20 data-v-acfd4c20></use></svg><span class="info-text" data-v-acfd4c20 data-v-acfd4c20>
          airamusume@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-acfd4c20><section class="info-sns clearfix" data-v-acfd4c20><a href="https://github.com/yuchanns" target="_blank" class="sns-link" data-v-acfd4c20><span title="GitHub: yuchanns" class="sns-icon" data-v-acfd4c20 data-v-acfd4c20><svg class="icon" style="font-size:1.5em;" data-v-acfd4c20 data-v-acfd4c20><title data-v-acfd4c20 data-v-acfd4c20>GitHub: yuchanns</title><use xlink:href="#icon-github" data-v-acfd4c20 data-v-acfd4c20></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-226a4f67><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span></span> <div class="post-nav-toc"> <ul><li><a href="/posts/2018/12/18/peewee-with-async.html#我们需要什么类库">我们需要什么类库</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#与tornado结合：同步阻塞下的情况">与tornado结合：同步阻塞下的情况</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#与tornado结合：异步硬盘io非阻塞下的情况">与tornado结合：异步硬盘IO非阻塞下的情况</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#其余常规操作">其余常规操作</a> <ul><li><a href="/posts/2018/12/18/peewee-with-async.html#插入-更新数据">插入/更新数据</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#jion查询">jion查询</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#union查询">union查询</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#聚合查询">聚合查询</a> <!----></li><li><a href="/posts/2018/12/18/peewee-with-async.html#删除操作">删除操作</a> <!----></li></ul></li></ul> </div></div> <div class="post-nav-comments"><svg class="icon"><title>comment</title><use xlink:href="#icon-comment"></use></svg> <a href="/posts/2018/12/18/peewee-with-async.html#post-comments">
      
    </a></div></div></aside></div> <footer class="footer" data-v-a7ec77da><p class="sns-links" data-v-a7ec77da><a href="https://github.com/yuchanns" target="_blank" class="sns-link" data-v-a7ec77da><span title="GitHub: yuchanns" class="sns-icon" data-v-a7ec77da data-v-a7ec77da><svg class="icon" style="font-size:25px;" data-v-a7ec77da data-v-a7ec77da><title data-v-a7ec77da data-v-a7ec77da>GitHub: yuchanns</title><use xlink:href="#icon-github" data-v-a7ec77da data-v-a7ec77da></use></svg></span></a></p> <p data-v-a7ec77da><span data-v-a7ec77da>Powered by </span> <a href="https://vuepress.vuejs.org" target="_blank" data-v-a7ec77da>
      Vuepress
    </a></p> <span id="busuanzi_container_site_pv" data-v-a7ec77da>你是第<span id="busuanzi_value_site_pv" data-v-a7ec77da></span>位访问者</span> <p data-v-a7ec77da><a href="http://beian.miit.gov.cn/" target="_blank" style="color: #666" data-v-a7ec77da>
        闽ICP备19005068号
    </a></p></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.f1298f72.js" defer></script><script src="/assets/js/3.cd7d6ac4.js" defer></script><script src="/assets/js/21.0fe3f19e.js" defer></script>
  </body>
</html>
